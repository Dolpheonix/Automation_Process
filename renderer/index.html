<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Automation</title>
  <style>
      .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .tab-buttons {
        display: flex;
        gap: 10px;
        margin: 20px;
    }

    .tab-btn {
        padding: 10px 20px;
        border: none;
        background-color: #eee;
        cursor: pointer;
        border-radius: 6px;
    }

    .tab-btn.active {
        background-color: #3498db;
        color: white;
        font-weight: bold;
    }
    .folder-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #ffffff;
        border: 1px solid #ccc;
        border-radius: 10px;
        padding: 10px 15px;
        margin-bottom: 0px;
        font-size: 12px;
        height: 10px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    .folder-path {
        flex-grow: 1;
        overflow-x: auto;
        white-space: nowrap;
    }

    .package-item {
        display: flex;
        flex-direction: column; /* ì¶”ê°€: ì„¸ë¡œ ì •ë ¬ */
        align-items: flex-start; /* ì¶”ê°€: ì™¼ìª½ ì •ë ¬ */
        justify-content: flex-start; /* ì¶”ê°€: ìœ„ìª½ ì •ë ¬ */
        background-color: #ffffff;
        border: 1px solid #ccc;
        border-radius: 10px;
        font-size: 12px;
        max-height: 120px;
        overflow-y: auto;
        margin: 0px;
        padding: 10px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    .package-info {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between; /* ì¢Œìš° ë ì •ë ¬ */
        font-size: 16px;
        width: 100%;
        margin-bottom: 10px;
        gap: 12px;
    }

    .package-info img {
        height: 24px;
        width: 24px;         /* í¬ê¸° ê³ ì • */
        object-fit: contain; /* ë¹„ìœ¨ ìœ ì§€í•˜ë©° ë§ì¶¤ */
        margin-right: 8px;   /* ë²„íŠ¼ê³¼ ê°„ê²© */
    }

    .package-list li {
        display: flex;
        align-items: center;
        width: 100%;
        gap: 12px;
        font-size: 13px;
        min-height: 36px;
        /* í•„ìš”í•˜ë‹¤ë©´ ì•„ë˜ë„ ì¶”ê°€ */
        /* justify-content: flex-start; */
    }

    .package-list .pkg-name {
        min-width: 150px;
        flex-shrink: 0;
        text-align: left;
    }
    .package-list .pkg-version {
        min-width: 100px;
        flex-shrink: 0;
        text-align: left;
    }
    .package-list .pkg-check {
        min-width: 40px;
        flex-shrink: 0;
        text-align: center;
    }
    .package-list .pkg-latest {
        min-width: 100px;
        flex-shrink: 0;
        text-align: right;
    }
    .content-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 0 15px;
    }

    .button-container {
        display: flex;
        gap: 10px;
        background-color: #ffffff;
        border: none;
        border-radius: 10px;
        padding: 10px 15px;
        margin-bottom: 20px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .main-button {
        background-color: #3498db;
        border: none;
        color: white;
        font-size: 16px;
        padding: 10px 20px;
        margin-right: 10px;
        cursor: pointer;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        transition: background-color 0.2s ease, transform 0.1s ease;
    }

    /* Hover íš¨ê³¼ */
    .main-button:hover {
        background-color: #2980b9;
        transform: translateY(-1px);
    }

    /* ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±° ë° ê³µí†µ ì„¤ì • */
    .action-button {
        background: none;
        border: none;
        font-size: 15px;
        cursor: pointer;
        padding: 6px;
        margin-left: 8px;
        border-radius: 6px;
        transition: background 0.2s ease;
    }

    /* Hover íš¨ê³¼ */
    .action-button:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    /* ìƒíƒœ ì•„ì´ì½˜ê³¼ ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
    .status-icon {
        font-size: 15px;
        margin-left: 10px;
        margin-right: 6px; /* ì—¬ë°± ì¶”ê°€ */
    }

    #output {
        margin-top: 20px;
        white-space: pre-wrap;
        background-color: #222;
        color: #eee;
        padding: 15px;
        border-radius: 8px;
        font-size: 12px;
        height: 700px;
        overflow-y: auto;
    }
    .pkg-status {
    min-width: 24px;
    text-align: center;
}
    </style>
</head>
<body>
    <div class="content-container">
        <h1>Automation</h1>

        <div class="button-container">
            <button id="add" class="main-button">â• í´ë” ì¶”ê°€</button>
        </div>

        <div class="tab-buttons">
            <button class="tab-btn active" id="tab-btn-pull" data-tab="tab-content-pull">Git Pull</button>
            <button class="tab-btn" id="tab-btn-pkg" data-tab="tab-content-pkg">Package Manager</button>
        </div>

        <div class="tab-content active" id="tab-content-pull">
            <div class="button-container">
                <button id="pull" class="main-button">ğŸ” ì „ì²´ Pull</button>
            </div>
            <ul id="folder-list"></ul>
            <div id="output"></div>
        </div>

        <div class="tab-content" id="tab-content-pkg">
            <div class="button-container">
                <button id="check" class="main-button">ğŸ” ì „ì²´ Check</button>
            </div>
            <ul id="pkg-list"></ul>
        </div>
    </div>
    <script>
        const listEl = document.getElementById('folder-list');
        const pkgListEl = document.getElementById('pkg-list');
        const outputEl = document.getElementById('output');

        let folderStatuses = {};

        async function renderGitPullList() {
            const folders = await window.api.getFolders();
            listEl.innerHTML = '';
            for (const folder of folders) {
                const li = document.createElement('li');
                li.className = 'folder-item';

                const pathSpan = document.createElement('span');
                pathSpan.className = 'folder-path';
                pathSpan.textContent = folder;

                const statusSpan = document.createElement('span');
                statusSpan.className = 'status-icon';
                const status = folderStatuses[folder];
                if (status === 'loading') {
                    statusSpan.textContent = 'â³';
                } else if (status === 'success') {
                    statusSpan.textContent = 'âœ…';
                } else if (status === 'fail') {
                    statusSpan.textContent = 'âŒ';
                } else {
                    statusSpan.textContent = '';
                }

                // ğŸ”„ ê°œë³„ ì‹¤í–‰ ë²„íŠ¼
                const pullBtn = document.createElement('button');
                pullBtn.className = 'action-button';
                pullBtn.textContent = 'ğŸ”„';
                pullBtn.onclick = async () => {
                    folderStatuses[folder] = 'loading';
                    renderGitPullList();

                    const result = await window.api.gitPullOne(folder);
                    folderStatuses[folder] = result.success ? 'success' : 'fail';
                    renderGitPullList();

                    outputEl.textContent += `ğŸ“ ${folder}\n${result.output}\n\n`;
                };

                const delBtn = document.createElement('button');
                delBtn.className = 'action-button';
                delBtn.textContent = 'ğŸ—‘ï¸';
                delBtn.onclick = async () => {
                    await window.api.removeFolder(folder);
                    delete folderStatuses[folder];
                    renderGitPullList();
                };

                li.appendChild(pathSpan);
                li.appendChild(statusSpan);
                li.appendChild(pullBtn);
                li.appendChild(delBtn);
                listEl.appendChild(li);
            }
        }

        async function renderPackageList() {
            const repoList = await window.pkgapi.detectAll();
            pkgListEl.innerHTML = '';
            for (const repo of repoList) {
                const li = document.createElement('li');
                li.className = 'package-item';

                const info = document.createElement('div');
                info.className = 'package-info';

                const pathSpan = document.createElement('span');
                pathSpan.className = 'folder-path';
                pathSpan.textContent = repo.folder;

                const image = document.createElement('img');
                if (repo.type === 'python') {
                    image.src = await window.getAssetPath.get('python.png');
                } else if (repo.type === 'node') {
                    image.src = await window.getAssetPath.get('nodejs.png');
                } else {
                    image.src = await window.getAssetPath.get('unknown.png');
                }

                const delBtn = document.createElement('button');
                delBtn.className = 'action-button';
                delBtn.textContent = 'ğŸ—‘ï¸';
                delBtn.onclick = async () => {
                    await window.api.removeFolder(folder);
                    delete folderStatuses[folder];
                    renderPackageList();
                };

                // ì˜¤ë¥¸ìª½ ë°•ìŠ¤ì— imageì™€ delBtnì„ ë¬¶ìŒ
                const rightBox = document.createElement('div');
                rightBox.style.display = 'flex';
                rightBox.style.alignItems = 'center';
                rightBox.appendChild(image);
                rightBox.appendChild(delBtn);

                const packageList = document.createElement('ul');
                packageList.className = 'package-list';
                for (const pkg of repo.packages) {
                    const pkgLi = document.createElement('li');

                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'pkg-name';
                    nameSpan.textContent = pkg.name + '  ';
                    const versionSpan = document.createElement('span');
                    versionSpan.className = 'pkg-version';
                    versionSpan.textContent = pkg.version;

                    const checkBtn = document.createElement('button');
                    checkBtn.className = 'action-button';
                    checkBtn.textContent = 'ğŸ”„';
                    
                    const latestVersionSpan = document.createElement('span');
                    latestVersionSpan.className = 'pkg-latest';
                    latestVersionSpan.style.minWidth = '100px'; // ê³ ì • ë„ˆë¹„(í•„ìš”ì‹œ ì¡°ì •)
                    latestVersionSpan.style.textAlign = 'right';
                    latestVersionSpan.style.marginLeft = '12px';

                    // ìƒíƒœ ì•„ì´ì½˜ span ì¶”ê°€
                    const statusIcon = document.createElement('span');
                    statusIcon.className = 'pkg-status';
                    statusIcon.style.marginLeft = '8px';

                    // ë²„íŠ¼ í´ë¦­ ì‹œ
                    checkBtn.onclick = async () => {
                        const result = await window.pkgapi.checkLatestPackage(repo.type, pkg.name);
                        latestVersionSpan.textContent = `${result}`;
                        const cmp = compareVersions(pkg.version, result);
                        if (cmp === -1) {
                            statusIcon.textContent = 'â¬†ï¸'; // ìµœì‹ ë²„ì „ì´ ë” ë†’ìŒ
                            statusIcon.title = 'ì—…ë°ì´íŠ¸ í•„ìš”';
                        } else if (cmp === 0) {
                            statusIcon.textContent = 'âœ…'; // ê°™ìŒ
                            statusIcon.title = 'ìµœì‹  ë²„ì „';
                        } else {
                            statusIcon.textContent = 'â“'; // ì˜ˆì™¸ ìƒí™©
                            statusIcon.title = 'ë¹„êµ ë¶ˆê°€';
                        }
                    };

                    pkgLi.appendChild(nameSpan);
                    pkgLi.appendChild(versionSpan);
                    pkgLi.appendChild(checkBtn);
                    pkgLi.appendChild(latestVersionSpan);
                    pkgLi.appendChild(statusIcon); // ìƒíƒœ ì•„ì´ì½˜ ì¶”ê°€
                    packageList.appendChild(pkgLi);
                }

                info.appendChild(pathSpan);
                info.appendChild(rightBox);
                li.appendChild(info);
                li.appendChild(packageList);
                pkgListEl.appendChild(li);
            }
        }

        document.getElementById('add').onclick = async () => {
            await window.api.addFolder();
            renderGitPullList();
        };

        document.getElementById('pull').onclick = async () => {
            const folders = await window.api.getFolders();
            outputEl.textContent = '';

            for (const folder of folders) {
            folderStatuses[folder] = 'loading';
            renderGitPullList();

            const result = await window.api.gitPullOne(folder);

            folderStatuses[folder] = result.success ? 'success' : 'fail';
            renderGitPullList();

            outputEl.textContent += `ğŸ“ ${folder}\n${result.output}\n\n`;
            }
        };

        document.getElementById('check').onclick = async () => {
            const repoList = await window.pkgapi.detectAll();
            const pkgList = pkgListEl.querySelectorAll('.package-item');
            for (const li of pkgList) {
                const path = li.querySelector('.folder-path').textContent.trim();
                const type = repoList.find(repo => repo.folder === path)?.type;
                const packageList = li.querySelector('.package-list');
                for (const pkgLi of packageList.querySelectorAll('li')) {
                    const pkgName = pkgLi.querySelector('.pkg-name').textContent.trim();
                    const result = await window.pkgapi.checkLatestPackage(type, pkgName);
                    const latestVersionSpan = pkgLi.querySelector('.pkg-latest');
                    latestVersionSpan.textContent = `${result}`;
                    // ìƒíƒœ ì•„ì´ì½˜ ì²˜ë¦¬
                    const versionSpan = pkgLi.querySelector('.pkg-version');
                    const statusIcon = pkgLi.querySelector('.pkg-status');
                    if (versionSpan && statusIcon) {
                        const cmp = compareVersions(versionSpan.textContent.trim(), result);
                        if (cmp === -1) {
                            statusIcon.textContent = 'â¬†ï¸';
                            statusIcon.title = 'ì—…ë°ì´íŠ¸ í•„ìš”';
                        } else if (cmp === 0) {
                            statusIcon.textContent = 'âœ…';
                            statusIcon.title = 'ìµœì‹  ë²„ì „';
                        } else {
                            statusIcon.textContent = 'â“';
                            statusIcon.title = 'ë¹„êµ ë¶ˆê°€';
                        }
                    }
                }
            }
        }

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                btn.classList.add('active');
                const contentId = btn.dataset.tab;
                document.getElementById(contentId).classList.add('active');

                if (contentId === 'tab-content-pkg') renderPackageList();
                else if (contentId === 'tab-content-pull') renderGitPullList();
            });
        });

        function normalizeVersion(ver) {
    // ^, ~, >=, <=, >, <, =, ê³µë°± ë“± ì œê±°
    return ver.replace(/^[\^~><= ]+/, '');
}

function compareVersions(current, latest) {
    const a = normalizeVersion(current).split('.').map(Number);
    const b = normalizeVersion(latest).split('.').map(Number);
    for (let i = 0; i < Math.max(a.length, b.length); i++) {
        const x = a[i] || 0, y = b[i] || 0;
        if (x < y) return -1;
        if (x > y) return 1;
    }
    return 0;
}

        renderGitPullList();
    </script>
</body>
</html>
